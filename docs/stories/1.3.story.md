# Story 1.3: Database Evolution — Schema Migration

**Epic:** 1 — Production Readiness
**Fase:** 1 (Fundacao)
**Status:** Draft
**Esforco:** 16h
**Dependencias:** 1.1 (Security Emergency)

---

## Descricao

Como desenvolvedor, preciso migrar o schema MVP para o schema completo com ENUMs, triggers, indexes e constraints adequados, usando um sistema de migrations versionado.

## Acceptance Criteria

### Migration System (2h)
- [ ] Supabase CLI configurado no projeto
- [ ] Primeiro migration criado a partir do schema atual
- [ ] `supabase db push` funcional
- [ ] Migrations versionadas em `supabase/migrations/`

### Schema Evolution (10h)
- [x] ENUMs criados: platform_enum, lead_status_enum, instance_status_enum
- [x] CHECK constraints migrados para ENUMs
- [x] `updated_at` adicionado em clients, products, leads
- [x] Trigger `update_updated_at_column()` em todas as tabelas
- [x] `phone_normalized` adicionado em leads com trigger de normalizacao
- [x] `deleted_at` adicionado em todas as tabelas (soft delete)
- [x] `recovery_attempts` e `next_contact_scheduled_at` em leads
- [x] `conversation_summary` em leads
- [ ] Tabela `agent_configs` criada (separada de products) — DEFERRED to Story 1.5
- [x] Limite de 50 mensagens em conversation_log (trigger)

### Indexes (2h)
- [x] `idx_leads_phone_norm` (phone_normalized) — CRITICO
- [x] `idx_products_ext_id_client` (external_product_id, client_id) UNIQUE — CRITICO
- [x] `idx_leads_created_at` (created_at DESC) — ALTO
- [x] `idx_products_client_active` (client_id, is_active) — ALTO
- [x] `idx_instances_client_status` (client_id, status) — ALTO
- [ ] `idx_leads_email_product` (email, product_id) UNIQUE — DEFERRED (risky without data cleanup)
- [x] `idx_leads_status_created` (status, created_at DESC) — ALTO

### Constraints (2h)
- [x] UNIQUE(email) em clients (partial, WHERE deleted_at IS NULL)
- [x] UNIQUE(external_product_id, client_id) em products (via idx_products_ext_id_client)
- [ ] NOT NULL em leads.phone (ou CHECK constraint) — DEFERRED (existing data may have NULLs)
- [x] CHECK(delay_minutes >= 1) em products
- [x] CHECK(value >= 0) em leads
- [x] COMMENT ON em todas as tabelas e colunas chave

## Technical Notes

- Manter nome `clients` (nao renomear para saas_customers)
- Phone normalization: `regexp_replace(phone, '[^0-9]', '', 'g')`, remover +55/0xx
- Migration deve popular phone_normalized para dados existentes
- Verificar UNIQUE constraints contra dados existentes antes de aplicar
- Backup obrigatorio antes de cada migration

## Definition of Done

- [ ] Todas as migrations aplicadas com sucesso
- [ ] Schema atualizado com ENUMs, triggers, indexes
- [ ] `supabase migration list` mostra todas as migrations
- [ ] Dados existentes preservados e normalizados
- [ ] EXPLAIN de queries criticas mostra uso de indexes

## File List

| File | Action |
|------|--------|
| `supabase/migrations/002_schema_evolution.sql` | CREATED |
| `types.ts` | MODIFIED — new fields on Lead, Product, Client; extended LeadStatus |
| `services/dataService.ts` | MODIFIED — mapLead and mapProduct updated with new columns |
| `docs/stories/1.3.story.md` | MODIFIED — progress tracking |

---
