# Story 1.5: Backend Consolidation — Python → Node.js

**Epic:** 1 — Production Readiness
**Fase:** 2 (Consolidacao)
**Status:** Draft
**Esforco:** 30h
**Dependencias:** 1.4 (Tests)

---

## Descricao

Como equipe de desenvolvimento, preciso consolidar os dois backends (Express + FastAPI) em um unico backend Node.js/Express, eliminando duplicacao de endpoints e simplificando deploy e manutencao.

## Acceptance Criteria

### AI Handler Migration (6h)
- [ ] `ai_handler.py` migrado para TypeScript (`services/aiHandler.ts`)
- [ ] OpenAI SDK Node.js configurado
- [ ] System prompt template preservado
- [ ] Conversation step logic preservada
- [ ] Phone normalization para busca de leads
- [ ] UAZAPI message sending preservado

### Task Queue Migration (6h)
- [ ] BullMQ instalado e configurado com Redis
- [ ] Recovery task implementada (equivalente ao Celery task)
- [ ] Delay configuravel por produto (delay_minutes)
- [ ] Retry logic com backoff
- [ ] Task timeout configurado
- [ ] Fix: usar `process_conversation_step` (nao `generate_message`)

### Webhook Endpoints (6h)
- [ ] Hotmart webhook handler unificado
- [ ] Kiwify webhook handler unificado
- [ ] UAZAPI webhook handler unificado
- [ ] Webhook signature verification (Hotmart HMAC)
- [ ] Kill switch: PURCHASE_APPROVED → converted_organically

### Input Validation (4h)
- [ ] Zod schemas para todos os webhook payloads
- [ ] Zod schemas para API requests
- [ ] Validation middleware no Express
- [ ] Error responses padronizados (JSON com status + message)

### WhatsApp Endpoints (4h)
- [ ] POST /api/whatsapp/connect/:clientId consolidado
- [ ] GET /api/whatsapp/status/:clientId consolidado
- [ ] POST /api/whatsapp/webhook consolidado
- [ ] QR code flow preservado

### Cleanup (4h)
- [ ] Backend Python removido (`backend/` directory)
- [ ] requirements.txt removido
- [ ] Celery references removidas
- [ ] Documentacao atualizada
- [ ] Feature parity checklist 100% validado

## Technical Notes

- BullMQ usa o mesmo Redis que Celery usava
- OpenAI Node.js SDK: `openai` package
- Manter a mesma estrutura de conversation_log no banco
- Testes da Story 1.4 devem passar apos migracao (feature parity)
- Rollback plan: manter branch com Python ate validacao completa

## Definition of Done

- [ ] Zero codigo Python no projeto
- [ ] Todos os endpoints funcionais em Node.js/Express
- [ ] Feature parity checklist 100% validado
- [ ] Testes da Story 1.4 passando
- [ ] Recovery pipeline funcional (webhook → delay → AI → WhatsApp)
- [ ] `npm start` inicia o unico backend

## File List

*Atualizado durante implementacao*

---
