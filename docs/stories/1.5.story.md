# Story 1.5: Backend Consolidation — Python → Node.js

**Epic:** 1 — Production Readiness
**Fase:** 2 (Consolidacao)
**Status:** Done
**Esforco:** 30h
**Dependencias:** 1.4 (Tests)

---

## Descricao

Como equipe de desenvolvimento, preciso consolidar os dois backends (Express + FastAPI) em um unico backend Node.js/Express, eliminando duplicacao de endpoints e simplificando deploy e manutencao.

## Acceptance Criteria

### AI Handler Migration (6h)
- [x] `ai_handler.py` migrado para TypeScript (`services/aiHandler.ts`)
- [x] OpenAI SDK Node.js configurado
- [x] System prompt template preservado
- [x] Conversation step logic preservada
- [x] Phone normalization para busca de leads
- [x] UAZAPI message sending preservado

### Task Queue Migration (6h)
- [x] BullMQ instalado e configurado com Redis
- [x] Recovery task implementada (equivalente ao Celery task)
- [x] Delay configuravel por produto (delay_minutes)
- [x] Retry logic com backoff
- [x] Task timeout configurado
- [x] Fix: usar `generateInitialMessage` (OpenAI) ao inves de `generate_message` inexistente

### Webhook Endpoints (6h)
- [x] Hotmart webhook handler unificado
- [x] Kiwify webhook handler unificado
- [x] UAZAPI webhook handler unificado
- [x] Webhook signature verification (Hotmart HMAC)
- [x] Kill switch: PURCHASE_APPROVED, ORDER_APPROVED → converted_organically

### Input Validation (4h)
- [x] Zod schemas para todos os webhook payloads
- [x] Zod schemas para API requests
- [x] Validation middleware no Express
- [x] Error responses padronizados (JSON com status + message)

### WhatsApp Endpoints (4h)
- [x] POST /api/whatsapp/connect/:clientId consolidado
- [x] GET /api/whatsapp/status/:clientId consolidado
- [x] POST /api/whatsapp/webhook consolidado (full message parsing + AI dispatch)
- [x] QR code flow preservado

### Cleanup (4h)
- [x] Backend Python removido (`backend/` directory)
- [x] requirements.txt removido
- [x] Celery references removidas
- [x] Documentacao atualizada
- [x] Feature parity checklist 100% validado

## Technical Notes

- BullMQ usa o mesmo Redis que Celery usava
- OpenAI Node.js SDK: `openai` package (instance-based v4+)
- Manter a mesma estrutura de conversation_log no banco
- Testes da Story 1.4 passam apos migracao (feature parity)
- Shared supabaseAdmin client (lib/supabaseAdmin.ts) instead of inline clients
- Fire-and-forget AI dispatch in webhook to avoid blocking HTTP response
- Worker startup guarded by `NODE_ENV !== 'test'`

## Definition of Done

- [x] Zero codigo Python no projeto
- [x] Todos os endpoints funcionais em Node.js/Express
- [x] Feature parity checklist 100% validado
- [x] Testes da Story 1.4 passando (30 original + 40 new = 70 total)
- [x] Recovery pipeline funcional (webhook → delay → AI → WhatsApp)
- [x] `npm start` inicia o unico backend

## File List

| File | Action |
|------|--------|
| `lib/supabaseAdmin.ts` | CREATED — shared backend Supabase client |
| `schemas/webhooks.ts` | CREATED — Zod schemas for webhook payloads |
| `schemas/api.ts` | CREATED — Zod schemas for API params |
| `middleware/validation.ts` | CREATED — validateBody middleware + errorResponse helper |
| `middleware/webhookSignature.ts` | CREATED — Hotmart signature verification |
| `services/uazapiService.ts` | CREATED — UAZAPI message sending |
| `services/aiHandler.ts` | CREATED — AI conversation handler (OpenAI) |
| `services/queueService.ts` | CREATED — BullMQ queue + scheduleRecovery |
| `services/recoveryWorker.ts` | CREATED — BullMQ worker for recovery jobs |
| `express-app.ts` | MODIFIED — use supabaseAdmin, complete webhook, add queue dispatch |
| `server.ts` | MODIFIED — add env vars, start recovery worker |
| `package.json` | MODIFIED — added zod, openai, bullmq, ioredis |
| `vitest.config.ts` | MODIFIED — expanded coverage includes |
| `tests/setup.ts` | MODIFIED — added OPENAI_API_KEY, REDIS_URL |
| `tests/helpers/fixtures.ts` | MODIFIED — fixed UAZAPI payload structure, added fromMe/noText fixtures |
| `tests/endpoints/whatsapp.test.ts` | MODIFIED — webhook parsing tests, fromMe filter, no text |
| `tests/endpoints/webhooks.test.ts` | MODIFIED — queue mock, scheduleRecovery verification, ORDER_APPROVED |
| `tests/endpoints/auth.test.ts` | MODIFIED — added service mocks |
| `tests/endpoints/validation.test.ts` | MODIFIED — updated webhook empty body expectation |
| `tests/schemas/webhooks.test.ts` | CREATED — 11 tests |
| `tests/middleware/webhookSignature.test.ts` | CREATED — 5 tests |
| `tests/services/uazapiService.test.ts` | CREATED — 3 tests |
| `tests/services/aiHandler.test.ts` | CREATED — 10 tests |
| `tests/services/queueService.test.ts` | CREATED — 2 tests |
| `tests/services/recoveryWorker.test.ts` | CREATED — 5 tests |
| `backend/` | DELETED (ai_handler.py, celery_worker.py, main.py, requirements.txt) |
| `docs/feature-parity-checklist.md` | MODIFIED — all items marked DONE |

---
