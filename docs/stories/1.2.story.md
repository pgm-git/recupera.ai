# Story 1.2: Auth Foundation — Supabase Auth + RLS

**Epic:** 1 — Production Readiness
**Fase:** 1 (Fundacao)
**Status:** Draft
**Esforco:** 21h
**Dependencias:** 1.1 (Security Emergency)

---

## Descricao

Como usuario SaaS, preciso de um fluxo de autenticacao completo (login, signup, forgot password) para que apenas usuarios autorizados acessam seus proprios dados.

## Acceptance Criteria

### Auth UI (12h)
- [ ] Pagina de Login com email + password
- [ ] Opcao de Magic Link como alternativa
- [ ] Pagina de Signup com email + password + nome
- [ ] Pagina de Forgot Password com envio de email
- [ ] Pagina de Reset Password
- [ ] Loading states durante operacoes de auth
- [ ] Error messages claros (email invalido, senha fraca, conta existente)
- [ ] Redirect para Dashboard apos login
- [ ] Session persistence (token refresh automatico)
- [ ] Protected routes (redirect para login se nao autenticado)
- [ ] Logout funcional (substituir botao hardcoded no Layout.tsx)

### RLS Policies (5h)
- [ ] Policies separadas por operacao (SELECT, INSERT, UPDATE) em todas as 4 tabelas
- [ ] Policy de clients: SELECT e UPDATE apenas para auth.uid() = id
- [ ] Policy de products: SELECT/INSERT/UPDATE para auth.uid() = client_id
- [ ] Policy de leads: SELECT para auth.uid() = client_id (INSERT/UPDATE via backend)
- [ ] Policy de instances: SELECT/UPDATE para auth.uid() = client_id
- [ ] DELETE bloqueado em todas as tabelas (soft delete via aplicacao)
- [ ] Funcoes SECURITY DEFINER para operacoes de backend

### Integracao (4h)
- [ ] Frontend usa Supabase Auth client (signIn, signUp, signOut, onAuthStateChange)
- [ ] Layout.tsx exibe nome e email do usuario logado (nao "Usuario Demo")
- [ ] dataService.ts usa session token (nao mais anon key sem auth)
- [ ] Webhook URL na Settings usa ID do usuario logado (nao placeholder)
- [ ] QRModal usa ID do usuario logado (nao mockClientId)

## Technical Notes

- Supabase Auth suporta email/password + magic link nativamente
- Frontend deve usar `supabase.auth.getSession()` e `onAuthStateChange()`
- Protected routes via React Router loader ou wrapper component
- RLS funciona automaticamente quando usuario esta logado via Supabase Auth
- Backend continua usando service_role para operacoes de webhook/celery

## Definition of Done

- [ ] Usuario pode criar conta, logar, resetar senha
- [ ] Dados sao filtrados por usuario (RLS funcional)
- [ ] Usuario A nao ve dados do Usuario B
- [ ] Session persiste entre refreshes
- [ ] Rotas protegidas redirecionam para login

## File List

*Atualizado durante implementacao*

---
