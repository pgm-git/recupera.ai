# Story 1.2: Auth Foundation — Supabase Auth + RLS

**Epic:** 1 — Production Readiness
**Fase:** 1 (Fundacao)
**Status:** Done
**Esforco:** 21h
**Dependencias:** 1.1 (Security Emergency)

---

## Descricao

Como usuario SaaS, preciso de um fluxo de autenticacao completo (login, signup, forgot password) para que apenas usuarios autorizados acessam seus proprios dados.

## Acceptance Criteria

### Auth UI (12h)
- [x] Pagina de Login com email + password
- [x] Opcao de Magic Link como alternativa
- [x] Pagina de Signup com email + password + nome
- [x] Pagina de Forgot Password com envio de email
- [x] Pagina de Reset Password
- [x] Loading states durante operacoes de auth
- [x] Error messages claros (email invalido, senha fraca, conta existente)
- [x] Redirect para Dashboard apos login
- [x] Session persistence (token refresh automatico)
- [x] Protected routes (redirect para login se nao autenticado)
- [x] Logout funcional (substituir botao hardcoded no Layout.tsx)

### RLS Policies (5h)
- [x] Policies separadas por operacao (SELECT, INSERT, UPDATE) em todas as 4 tabelas
- [x] Policy de clients: SELECT e UPDATE apenas para auth.uid() = id
- [x] Policy de products: SELECT/INSERT/UPDATE para auth.uid() = client_id
- [x] Policy de leads: SELECT para auth.uid() = client_id (INSERT/UPDATE via backend)
- [x] Policy de instances: SELECT/UPDATE para auth.uid() = client_id
- [x] DELETE bloqueado em todas as tabelas (soft delete via aplicacao)
- [x] Funcoes SECURITY DEFINER para operacoes de backend

### Integracao (4h)
- [x] Frontend usa Supabase Auth client (signIn, signUp, signOut, onAuthStateChange)
- [x] Layout.tsx exibe nome e email do usuario logado (nao "Usuario Demo")
- [x] dataService.ts usa session token (nao mais anon key sem auth)
- [x] Webhook URL na Settings usa ID do usuario logado (nao placeholder)
- [x] QRModal usa ID do usuario logado (nao mockClientId)

## Technical Notes

- Supabase Auth suporta email/password + magic link nativamente
- Frontend deve usar `supabase.auth.getSession()` e `onAuthStateChange()`
- Protected routes via React Router loader ou wrapper component
- RLS funciona automaticamente quando usuario esta logado via Supabase Auth
- Backend continua usando service_role para operacoes de webhook/celery

## Definition of Done

- [x] Usuario pode criar conta, logar, resetar senha
- [x] Dados sao filtrados por usuario (RLS funcional)
- [x] Usuario A nao ve dados do Usuario B
- [x] Session persiste entre refreshes
- [x] Rotas protegidas redirecionam para login

## File List

| File | Action |
|------|--------|
| `contexts/AuthContext.tsx` | EXISTS — Full auth context (signIn, signUp, signOut, resetPassword, updatePassword) |
| `components/ProtectedRoute.tsx` | EXISTS — Route protection with redirect to /login |
| `pages/Login.tsx` | EXISTS — Email + password login page |
| `pages/Signup.tsx` | EXISTS — Email + password + name signup |
| `pages/ForgotPassword.tsx` | EXISTS — Forgot password email flow |
| `pages/ResetPassword.tsx` | EXISTS — Reset password page |
| `hooks/useAuth.ts` | EXISTS — useAuth hook |
| `lib/supabase.ts` | EXISTS — Frontend Supabase client with isSupabaseConfigured() |
| `App.tsx` | EXISTS — AuthProvider + ProtectedRoute routing |
| `components/Layout.tsx` | EXISTS — Shows user profile (name, email, initials) from auth |
| `supabase/migrations/001_auth_rls_policies.sql` | CREATED — Per-operation RLS policies + handle_new_user trigger + SECURITY DEFINER functions |
| `pages/Settings.tsx` | MODIFIED — Fixed "Backend Python" text references |
| `components/QRModal.tsx` | MODIFIED — Fixed "Backend Python" text references |

---
