# Story 1.4: Test Foundation — Setup + Baseline Tests

**Epic:** 1 — Production Readiness
**Fase:** 1.5 (Testes)
**Status:** Done
**Esforco:** 10h
**Dependencias:** 1.2 (Auth), 1.3 (DB Schema)

---

## Descricao

Como desenvolvedor, preciso de um framework de testes configurado e testes baseline para os endpoints e services existentes, para poder validar a migracao do backend Python sem regressoes.

## Acceptance Criteria

### Test Setup (2h)
- [x] Vitest configurado com TypeScript support
- [x] Test helpers para Supabase mock
- [x] Test helpers para HTTP requests (supertest)
- [x] npm scripts: `test`, `test:watch`, `test:coverage`
- [x] Coverage report configurado (minimo: statements)

### Endpoint Tests (4h)
- [x] Test: POST /api/webhooks/:clientId (Hotmart payload)
- [x] Test: POST /api/webhooks/:clientId (Kiwify payload)
- [x] Test: POST /api/whatsapp/webhook (UAZAPI message)
- [x] Test: POST /api/whatsapp/connect/:clientId
- [x] Test: GET /api/whatsapp/status/:clientId
- [x] Test: Endpoints rejeitam requests sem auth
- [x] Test: Endpoints rejeitam payloads invalidos

### Service Tests (2h)
- [x] Test: dataService.getLeads() filtra por client_id
- [x] Test: dataService.saveProductConfig() valida campos
- [x] Test: apiService.connectWhatsApp() handles errors
- [x] Test: apiService.getStatus() handles timeout

### Feature Parity Checklist (2h)
- [x] Documentar TODOS os comportamentos do FastAPI/Python
- [x] Mapear cada endpoint Python → equivalente Node.js
- [x] Identificar logica unica no ai_handler.py
- [x] Identificar logica unica no celery_worker.py
- [x] Checklist pronto para validacao pos-migracao

## Technical Notes

- Usar Vitest (compativel com Vite, mais rapido que Jest)
- Mocks de Supabase via `vi.mock()` ou test client
- supertest para endpoint testing
- Coverage target: 60% statements para esta story

## Definition of Done

- [x] `npm test` roda sem erros
- [x] Coverage >= 30% (baseline, sera expandido) — Achieved: 70.58%
- [x] Feature parity checklist documentado
- [x] Todos os endpoints criticos tem pelo menos 1 teste

## File List

| File | Action |
|------|--------|
| `package.json` | MODIFIED — added vitest, supertest devDeps + test scripts |
| `tsconfig.json` | MODIFIED — added vitest/globals to types |
| `vitest.config.ts` | CREATED — vitest configuration with v8 coverage |
| `express-app.ts` | CREATED — Express app extracted from server.ts |
| `server.ts` | MODIFIED — slim entrypoint (env validation + server start) |
| `tests/setup.ts` | CREATED — test env vars |
| `tests/helpers/supabase-mock.ts` | CREATED — chainable Supabase mock builder |
| `tests/helpers/fixtures.ts` | CREATED — test data (payloads, mock DB records) |
| `tests/endpoints/webhooks.test.ts` | CREATED — 7 tests (Hotmart, Kiwify, errors) |
| `tests/endpoints/whatsapp.test.ts` | CREATED — 6 tests (connect, status, webhook) |
| `tests/endpoints/auth.test.ts` | CREATED — 3 tests + 5 todo (insecure state documented) |
| `tests/endpoints/validation.test.ts` | CREATED — 4 tests (empty body, missing params, non-JSON) |
| `tests/services/dataService.test.ts` | CREATED — 6 tests (getLeads, saveProductConfig) |
| `tests/services/apiService.test.ts` | CREATED — 4 tests (connectInstance, checkInstanceStatus) |
| `docs/feature-parity-checklist.md` | CREATED — full Python vs Node.js comparison |

---
